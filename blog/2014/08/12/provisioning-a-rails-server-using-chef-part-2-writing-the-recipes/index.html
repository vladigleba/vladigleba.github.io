
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Provisioning a Rails Server Using Chef, Part 2: Writing the Recipes - Vladi Gleba</title>
  <meta name="author" content="Vladi Gleba">

  
  <meta name="description" content="Learn how to write recipes in Chef to provision a Rails server and install Node.js, PostgreSQL, rbenv, Ruby, Redis, and Nginx.">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://vladigleba.github.io/blog/2014/08/12/provisioning-a-rails-server-using-chef-part-2-writing-the-recipes">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Vladi Gleba" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>

  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Vladi Gleba</a></h1>
  
    <h2>I create things for the internet.</h2>
  
</hgroup>

</header>
  <nav role="navigation">  
  
  
  
  
<ul class="main-navigation">
 </ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Provisioning a Rails Server Using Chef, Part 2: Writing the Recipes</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-12T09:29:00-07:00" pubdate data-updated="true">Aug 12<span>th</span>, 2014</time>
        

|


        
          <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>In <a href="/blog/2014/07/28/provisioning-a-rails-server-using-chef-part-1-introduction-to-chef-solo/">part 1</a>, we learned about Chef Solo and used it to create a standard Chef directory structure, along with our own cookbook. Now it&rsquo;s time to start writing the recipes we will run to provision our Rails server and install Node.js, PostgreSQL, rbenv, Ruby, Redis, and Nginx.</p>

<!-- more -->


<h1>Defining Default Values</h1>

<p>The first thing we&rsquo;ll do is define some default values for our recipes. Go ahead and create a new file called <code>default.rb</code> inside the <code>/attributes</code> directory of the cookbook you created in part 1, and add the following code into it:</p>

<figure class='code'><figcaption><span>default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">default</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span>               <span class="o">=</span> <span class="s1">&#39;phindee&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="s1">&#39;nodejs&#39;</span><span class="o">][</span><span class="s1">&#39;dir&#39;</span><span class="o">]</span>     <span class="o">=</span> <span class="s1">&#39;/usr/local&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="s1">&#39;nodejs&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;0.10.29&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span>   <span class="o">=</span> <span class="s1">&#39;2.1.2&#39;</span>
</span><span class='line'><span class="n">default</span><span class="o">[</span><span class="s1">&#39;redis&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span>  <span class="o">=</span> <span class="s1">&#39;2.8.13&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>These are called attributes, and they&rsquo;re just variables that are later used in recipes. We&rsquo;re defining simple things here like the app name, the directory where Node.js will be installed, and the versions of the software we&rsquo;ll be installing. Storing such things in a single file makes it easy to modify them later on.</p>

<p>This file is great for storing attributes that will be shared with more than one server, but attributes that are server-specific, like ports, usernames, and passwords, will be stored in another JSON file outside our cookbook. If you followed part 1, your cookbook is stored in your app&rsquo;s <code>/config/chef/site-cookbooks</code> directory, but this JSON file will reside inside the <code>/config/chef/nodes</code> directory, and it&rsquo;ll be named after the IP address of the server you&rsquo;ll be provisioning (for example, <code>123.123.123.123.json</code>).</p>

<p>Go ahead and create the file now, and add the following code into it (be sure to replace the attributes with your own):</p>

<figure class='code'><figcaption><span>123.123.123.123.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;group&quot;</span><span class="p">:</span> <span class="s2">&quot;foobars&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password-shadow-hash&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&quot;db&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;root_password&quot;</span><span class="p">:</span> <span class="s2">&quot;secret&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;bob&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;secret&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Due to the sensitive nature of this file, it&rsquo;s best to add it to your <code>.gitignore</code> file so it doesn&rsquo;t get uploaded to GitHub. Here&rsquo;s the line you&rsquo;ll need to add:</p>

<figure class='code'><figcaption><span>.gitignore</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>/config/chef/nodes/123.123.123.123.json
</span></code></pre></td></tr></table></div></figure>


<p>One thing I&rsquo;d like to point out is Chef doesn&rsquo;t use plain text passwords when creating new users. Instead, it uses a <a href="http://en.wikipedia.org/wiki/Passwd#Shadow_file">shadow hash</a> of the plain text password, so the <code>user.password</code> attribute must be a shadow hash. If you have the <code>openssl</code> command installed on your local computer, you can create a password shadow hash by running the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>openssl passwd -1 <span class="s2">&quot;theplaintextpassword&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This just uses the <code>passwd</code> command provided by <code>openssl</code> to create an MD5-based hash of the password (specified by the <code>-1</code> flag). You can then copy and paste the string that the command returns into the JSON file above. Once the user is set up on our node, you&rsquo;ll still use the plain text password to log in, just like always. I wasn&rsquo;t able to get shadow hash passwords working with PostgreSQL though, which is why I&rsquo;m just using the plain text password there, but feel free to leave a comment if you know how to make it work.</p>

<p>One last thing I want to mention is that if you have the same attribute defined in both <code>default.rb</code> and the JSON file, the latter will always override the former.</p>

<h1>Writing Recipes</h1>

<p>Now that the attributes are defined, we&rsquo;re ready to start writing the recipes themselves. These recipes do the exact same server setup as the one covered in the <a href="/blog/topics/deployment-series/">&ldquo;Deploying Rails Apps&rdquo; series</a>, so I won&rsquo;t be explaining the whys behind the things I do here since that&rsquo;s already covered in the series itself. If you&rsquo;ve never provisioned a server from scratch before, it&rsquo;s best to read that series first before continuing.</p>

<h2>The First One</h2>

<p>Our first recipe will install various packages and set the correct time zone. Create a new file called <code>default.rb</code> inside the <code>/recipes</code> directory of your cookbook, and add the following code into it:</p>

<figure class='code'><figcaption><span>default.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># update package database</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;apt-get update&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># install packages</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;telnet&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;postfix&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;curl&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;git-core&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;zlib1g-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;libssl-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;libreadline-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;libyaml-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;libsqlite3-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;sqlite3&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;libxml2-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;libxslt1-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;libpq-dev&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;build-essential&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;tree&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># set timezone</span>
</span><span class='line'><span class="n">bash</span> <span class="s2">&quot;set timezone&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    echo &#39;US/Pacific-New&#39; &gt; /etc/timezone</span>
</span><span class='line'><span class="sh">    dpkg-reconfigure -f noninteractive tzdata</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;date | grep -q &#39;PDT\|PST&#39;&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Chef uses a domain-specific language (DSL) for writing recipes, and the code above is what it looks like. A recipe is made up of resources, and a resource is simply an abstraction of some shell code you would run to provision your server that Chef already implemented for you and wrapped it in a resource. Chef provides most of the resources you will need, but you can also write your own.</p>

<p>In the file above, we&rsquo;re using three resources: <a href="http://docs.getchef.com/chef/resources.html#execute"><code>execute</code></a>, <a href="http://docs.getchef.com/chef/resources.html#package"><code>package</code></a>, and <a href="http://docs.getchef.com/chef/resources.html#bash"><code>bash</code></a>. The <code>execute</code> resource executes a command, the <code>package</code> resource manages packages, and the <code>bash</code> resource executes scripts using the Bash interpreter. So in the code above, we&rsquo;re first using <code>execute</code> to run <code>apt-get update</code> to fetch the latest updates for the packages on our node. (A server is known as a node in Chef terminology.) Next, we use <code>package</code> to install the various packages our node will need, and finally, we use <code>bash</code> to execute two lines of code that will set the correct time zone (be sure to modify the <code>echo</code> command so it sets your own time zone).</p>

<p>Each resource has various attributes that you can optionally specify inside a <code>do...end</code> block. For example, with the <code>bash</code> resource, we&rsquo;re using the <code>code</code> attribute to specify the code that will run to set the timezone (see the <a href="http://docs.getchef.com/chef/resources.html#bash">documentation</a> to learn about the other attributes it supports). This resource is similar to the <code>execute</code> resource, which also runs commands, but <code>execute</code> is used to run a single command, while <code>bash</code>&rsquo;s <code>code</code> attribute is used to run more than one.</p>

<p>We could&rsquo;ve specified attributes for the <code>execute</code> and <code>package</code> resources as well, but there is no need in this case. For example, this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">execute</span> <span class="s2">&quot;update packages&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;apt-get update&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>is equivalent to <code>execute "apt-get update"</code>. The only difference between the two is the longer version gives the resource block a name&mdash;&ldquo;update packages&rdquo; in this case, but it could&rsquo;ve been anything&mdash;while the shorter version just specifies the command to execute. When the <code>command</code> attribute is missing, the resource name is the command that is executed, and that&rsquo;s why the shorter version works just as well.</p>

<p>One last interesting thing about the <code>bash</code> resource is the <code>not_if</code> line. This is called a <a href="http://docs.getchef.com/chef/resources.html#guards">guard attribute</a>, and it can be applied to any resource, not just <code>bash</code>. It&rsquo;s used to prevent a resource from running if certain conditions are met. In this case, I&rsquo;m specifying a command that will output the current date and search for either the word &ldquo;PDT&rdquo; (Pacific Daylight Time) or &ldquo;PST&rdquo; (Pacific Standard Time) to see if the correct time zone is set (be sure to modify this for your own time zone). The guard will be applied and the resource won&rsquo;t run if the command returns <code>0</code>, which is the case with <code>grep</code> when it finds a match.</p>

<h2>Working with Users</h2>

<p>This next recipe will create a new user and group. Add a new file called <code>users.rb</code> to the directory containing the previous recipe, and fill it with the following:</p>

<figure class='code'><figcaption><span>users.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># create group</span>
</span><span class='line'><span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create user and add to group</span>
</span><span class='line'><span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gid</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">home</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">password</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;password&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class='line'>  <span class="n">supports</span> <span class="n">manage_home</span><span class="p">:</span> <span class="kp">true</span> <span class="c1"># need for /home creation</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># give group sudo privileges</span>
</span><span class='line'><span class="n">bash</span> <span class="s2">&quot;give group sudo privileges&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    sed -i &#39;/%#{node[&#39;group&#39;]}.*/d&#39; /etc/sudoers</span>
</span><span class='line'><span class="sh">    echo &#39;%#{node[&#39;group&#39;]} ALL=(ALL) ALL&#39; &gt;&gt; /etc/sudoers</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;grep -xq &#39;%</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> ALL=(ALL) ALL&#39; /etc/sudoers&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we&rsquo;re first using the <a href="http://docs.getchef.com/chef/resources.html#group"><code>group</code> resource</a> to create a new group whose name will come from the <code>group</code> attribute defined in the JSON file we created earlier. Note the syntax to access that attribute; it stays the same whether you&rsquo;re accessing attributes from the JSON file or the <code>default.rb</code> file.</p>

<p>Next, we use the <a href="http://docs.getchef.com/chef/resources.html#user"><code>user</code> resource</a> to create a new user whose name is also defined in the JSON file. But now it gets interesting because there are a handful of additional attributes we&rsquo;re using:</p>

<ul>
<li><code>gid</code> assigns this user to the group we created right before</li>
<li><code>home</code> specifies the location of the user&rsquo;s home directory</li>
<li><code>password</code> accepts a shadow hash of the users password</li>
<li><code>shell</code> specifies the login shell that the user will log in with (user won&rsquo;t have login access without this attribute)</li>
<li><code>supports</code> sets <code>manage_home</code> to <code>true</code> to tell Chef to create the home directory when the user is created</li>
</ul>


<p>The last <code>bash</code> resource adds a line to the <code>sudoers</code> file that gives the group <code>sudo</code> privileges, but it does this only if the line isn&rsquo;t already there.</p>

<h1>Restricting SSH Access</h1>

<p>The next thing on our list is restricting SSH access to our node. Add the following code into a new file called <code>ssh.rb</code>:</p>

<figure class='code'><figcaption><span>ssh.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># tell chef about ssh service</span>
</span><span class='line'><span class="n">service</span> <span class="s1">&#39;ssh&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Service</span><span class="p">:</span><span class="ss">:Upstart</span>
</span><span class='line'>  <span class="n">supports</span> <span class="o">[</span><span class="ss">:status</span><span class="p">,</span> <span class="ss">:restart</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># modify port</span>
</span><span class='line'><span class="n">bash</span> <span class="s2">&quot;modify port&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    sed -i &#39;/Port.*/d&#39; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="sh">    echo &#39;Port #{node[&#39;port&#39;]}&#39; &gt;&gt; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[ssh]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;grep -xq &#39;Port </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;port&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; /etc/ssh/sshd_config&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># disable root login</span>
</span><span class='line'><span class="n">bash</span> <span class="s2">&quot;disable root login&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    sed -i &#39;/PermitRootLogin.*/d&#39; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="sh">    echo &#39;PermitRootLogin no&#39; &gt;&gt; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[ssh]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;grep -xq &#39;PermitRootLogin no&#39; /etc/ssh/sshd_config&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># restrict login only to created user</span>
</span><span class='line'><span class="n">bash</span> <span class="s2">&quot;restrict login only to created user&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    sed -i &#39;/AllowUsers.*/d&#39; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="sh">    echo &#39;AllowUsers #{node[&#39;user&#39;][&#39;name&#39;]}&#39; &gt;&gt; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[ssh]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;grep -xq &#39;AllowUsers </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; /etc/ssh/sshd_config&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># disable dns</span>
</span><span class='line'><span class="n">bash</span> <span class="s2">&quot;disable dns&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    sed -i &#39;/UseDNS.*/d&#39; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="sh">    echo &#39;UseDNS no&#39; &gt;&gt; /etc/ssh/sshd_config</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[ssh]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;grep -xq &#39;UseDNS no&#39; /etc/ssh/sshd_config&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Chef has a <a href="http://docs.getchef.com/chef/resources.html#service"><code>service</code> resource</a> designed for managing services like SSH. We tell it to manage SSH by specifying &ldquo;ssh&rdquo; as the resource name, and since we don&rsquo;t have a <code>service_name</code> attribute listed, Chef automatically assumes that the resource name is also the name of the service we want to manage.</p>

<p>We then use the <code>provider</code> attribute to tell Chef to use <a href="https://en.wikipedia.org/wiki/Upstart">upstart</a> to manage the service. This is necessary whenever there are two or more ways available for managing a service, which is the case with SSH on the node I&rsquo;m running. My node has an upstart job (located in <code>/etc/init</code>) and a traditional init script (located in <code>/etc/init.d</code>) for managing SSH, and I decided to go with upstart since it&rsquo;s superior, but either will work for our purposes. If there is only one service provider available, Chef will detect it automatically, and there is no need for the <code>provider</code> attribute.</p>

<p>By default, Chef inspects the process table to see if a service is running, but it&rsquo;s also possible to use the <code>service ssh status</code> command (which is more reliable) to do the same thing. That&rsquo;s why we use the <code>supports</code> attribute to tell Chef to use the <code>status</code> command instead. And while we&rsquo;re at it, we also give Chef permission to use the <code>restart</code> command to restart SSH.</p>

<p>Once the service is defined, we use the <code>bash</code> resource to modify the SSH port, disable <code>root</code> login, restrict login access just to our created user, and disable DNS lookup. Each <code>bash</code> block also uses the <a href="http://docs.getchef.com/chef/resources.html#notifications"><code>notifies</code> attribute</a> to tell the SSH <code>service</code> resource we just defined to restart itself <em>if</em> the code inside the <code>code</code> attribute actually runs. But we use the <code>delayed</code> timer to tell Chef to queue up the notification and run in at the very end. The other option is to use the <code>immediate</code> timer to do the restart immediately, but we don&rsquo;t want to restart the service four separate times when we can just wait till the end and do it just once.</p>

<p>And just like in the two previous recipes, we use the <code>not_if</code> guard to make  sure the <code>bash</code> resources don&rsquo;t run if the necessary changes are already made.</p>

<h2>Installing Node.js</h2>

<p>Next order of business is installing Node.js. Add the following code into a new file called <code>nodejs.rb</code>:</p>

<figure class='code'><figcaption><span>nodejs.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># variables for node.js</span>
</span><span class='line'><span class="n">arch</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;kernel&#39;</span><span class="o">][</span><span class="s1">&#39;machine&#39;</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/x86_64/</span> <span class="p">?</span> <span class="s2">&quot;x64&quot;</span> <span class="p">:</span> <span class="s2">&quot;x86&quot;</span>
</span><span class='line'><span class="n">package_stub</span> <span class="o">=</span> <span class="s2">&quot;node-v</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;nodejs&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">-linux-</span><span class="si">#{</span><span class="n">arch</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="n">nodejs_tar</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">package_stub</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span>
</span><span class='line'><span class="n">nodejs_url</span> <span class="o">=</span> <span class="s2">&quot;http://nodejs.org/dist/v</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;nodejs&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">nodejs_tar</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="n">executable</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;nodejs&#39;</span><span class="o">][</span><span class="s1">&#39;dir&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/bin/node&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># download tar file</span>
</span><span class='line'><span class="n">remote_file</span> <span class="s2">&quot;/usr/local/src/</span><span class="si">#{</span><span class="n">nodejs_tar</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="n">nodejs_url</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:create_if_missing</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># install node.js from binaries</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;install node.js&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">command</span> <span class="o">&lt;&lt;-</span><span class="no">EOF</span>
</span><span class='line'><span class="sh">    tar xf /usr/local/src/#{nodejs_tar} \</span>
</span><span class='line'><span class="sh">    --strip-components=1 --no-same-owner \</span>
</span><span class='line'><span class="sh">    -C #{node[&#39;nodejs&#39;][&#39;dir&#39;]} \</span>
</span><span class='line'><span class="sh">    #{package_stub}/bin \</span>
</span><span class='line'><span class="sh">    #{package_stub}/lib \</span>
</span><span class='line'><span class="sh">    #{package_stub}/share</span>
</span><span class='line'><span class="no">  EOF</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="sb">`</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;nodejs&#39;</span><span class="o">][</span><span class="s1">&#39;dir&#39;</span><span class="o">]</span><span class="si">}</span><span class="sb">/bin/node --version`</span><span class="o">.</span><span class="n">chomp</span> <span class="o">==</span> <span class="s2">&quot;v</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;nodejs&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The very first line makes use of <a href="http://docs.getchef.com/ohai.html">Ohai</a>, a tool Chef uses to detect attributes on a node and make them available for use in recipes. We&rsquo;re extracting the type of architecture our node is running on to make sure we download the correct tar file for installing Node.js.</p>

<p>We download the tar file using a resource called <a href="http://docs.getchef.com/chef/resources.html#remote-file"><code>remote_file</code></a>, and we then use the <code>source</code> attribute to specify the source of the tar file, <code>mode</code> to specify its mode, and <code>action</code> to tell Chef to create the file only if it&rsquo;s not already there.</p>

<p>One interesting thing about the <code>action</code> attribute is it&rsquo;s actually present in each resource we write, whether we explicitly assign one or not. Not every resource has the same actions though. <code>remote_file</code>, for example, has <code>create</code>, <code>create_if_missing</code>, <code>delete</code>, and <code>touch</code> actions, while <code>bash</code> only has <code>run</code> and <code>nothing</code> actions. But every resource is assigned a default action, if we don&rsquo;t assign one ourselves (the resource&rsquo;s documentation will specify which action is assigned by default).</p>

<p>After the file is downloaded, we use <code>execute</code> to do the install. One interesting thing about this resource is the <code>not_if</code> guard, which executes some Ruby code, whereas the previous one only executed shell commands. Guards  can run a shell command specified inside a string, or Ruby code specified inside a block. Ruby code must return either <code>true</code> or <code>false</code>, while shell commands can return any value, but the guard runs only if a zero is returned (see the <a href="http://docs.getchef.com/chef/resources.html#guards">documentation</a>).</p>

<p>So in the code above, we&rsquo;re first executing some Ruby code to determine if a file exists, and then we execute a shell command to output the Node.js version we installed, but this output is processed by Ruby and gets compared with the version we&rsquo;ve specified in our attributes file. As a result, Node.js won&rsquo;t be installed if there is a Node.js executable already present on the node that returns the correct version number. (Note that shell commands will be processed by Ruby only if they&rsquo;re specified using backquotes).</p>

<h2>Installing PostgreSQL</h2>

<p>Our next recipe will install PostgreSQL. Create a new file called <code>postgres.rb</code>, and add the following code into it:</p>

<figure class='code'><figcaption><span>postgres.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">package</span> <span class="s2">&quot;postgresql&quot;</span>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;postgresql-contrib&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># change postgres password</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;change postgres password&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="s2">&quot;postgres&quot;</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;psql -c </span><span class="se">\&quot;</span><span class="s2">alter user postgres with password &#39;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;db&#39;</span><span class="o">][</span><span class="s1">&#39;root_password&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39;;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create new postgres user</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;create new postgres user&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="s2">&quot;postgres&quot;</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;psql -c </span><span class="se">\&quot;</span><span class="s2">create user </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;db&#39;</span><span class="o">][</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> with password &#39;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;db&#39;</span><span class="o">][</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;password&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39;;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="sb">`sudo -u postgres psql -tAc </span><span class="se">\&quot;</span><span class="sb">SELECT * FROM pg_roles WHERE rolname=&#39;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;db&#39;</span><span class="o">][</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="sb">&#39;</span><span class="se">\&quot;</span><span class="sb"> | wc -l`</span><span class="o">.</span><span class="n">chomp</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create new postgres database</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;create new postgres database&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="s2">&quot;postgres&quot;</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;psql -c </span><span class="se">\&quot;</span><span class="s2">create database </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> owner </span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;db&#39;</span><span class="o">][</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="sb">`sudo -u postgres psql -tAc </span><span class="se">\&quot;</span><span class="sb">SELECT * FROM pg_database WHERE datname=&#39;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span><span class="si">}</span><span class="sb">&#39;</span><span class="se">\&quot;</span><span class="sb"> | wc -l`</span><span class="o">.</span><span class="n">chomp</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This recipe is fairly straightforward. We install Postgres using the <code>package</code> resource and use <code>execute</code> to modify the <code>postgres</code> user&rsquo;s password. We also create new user, along with a new database, which is assigned to the newly created user. (Note that we&rsquo;re using the <code>user</code> attribute to execute these commands as the <code>postgres</code> user, which is necessary because otherwise Postgres would run these commands as <code>root</code>, and such a user does not exist in Postgres by default.)</p>

<h2>Installing rbenv and Ruby</h2>

<p>It&rsquo;s now time to install rbenv and Ruby. Add the following code into a new file called <code>rbenv.rb</code>:</p>

<figure class='code'><figcaption><span>rbenv.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># create .bash_profile file</span>
</span><span class='line'><span class="n">cookbook_file</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/.bash_profile&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;bash_profile&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">owner</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># install rbenv</span>
</span><span class='line'><span class="n">bash</span> <span class="s1">&#39;install rbenv&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">cwd</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    export HOME=/home/#{node[&#39;user&#39;][&#39;name&#39;]}</span>
</span><span class='line'><span class="sh">    curl -L https://raw.github.com/fesplugas/rbenv-installer/master/bin/rbenv-installer | bash</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/.rbenv/bin/rbenv&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># install ruby</span>
</span><span class='line'><span class="n">version_path</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/.rbenv/version&quot;</span>
</span><span class='line'><span class="n">bash</span> <span class="s1">&#39;install ruby&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">cwd</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    export HOME=/home/#{node[&#39;user&#39;][&#39;name&#39;]}</span>
</span><span class='line'><span class="sh">    export RBENV_ROOT=&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'><span class="sh">    export PATH=&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'><span class="sh">    rbenv init -</span>
</span><span class='line'>
</span><span class='line'><span class="sh">    rbenv install #{node[&#39;ruby&#39;][&#39;version&#39;]}</span>
</span><span class='line'><span class="sh">    rbenv global #{node[&#39;ruby&#39;][&#39;version&#39;]}</span>
</span><span class='line'><span class="sh">    echo &#39;gem: -–no-ri -–no-rdoc&#39; &gt; .gemrc</span>
</span><span class='line'><span class="sh">    .rbenv/bin/rbenv exec gem install bundler</span>
</span><span class='line'><span class="sh">    rbenv rehash</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">version_path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="sb">`cat </span><span class="si">#{</span><span class="n">version_path</span><span class="si">}</span><span class="sb">`</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">split</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re using a new resource here called <a href="http://docs.getchef.com/chef/resources.html#cookbook-file"><code>cookbook_file</code></a>, which takes a file in our recipe and copies it to a specific location on our node. The file were creating is called <code>bash_profile</code>, and it contains some code that allows rbenv to initialize itself properly (store it in your cookbook&rsquo;s <code>/files/default</code> directory):</p>

<figure class='code'><figcaption><span>bash_profile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">RBENV_ROOT</span><span class="o">=</span><span class="s2">&quot;${HOME}/.rbenv&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${RBENV_ROOT}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;${RBENV_ROOT}/bin:${PATH}&quot;</span>
</span><span class='line'>  <span class="nb">eval</span> <span class="s2">&quot;$(rbenv init -)&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you go back to the <code>cookbook_file</code> resource, you&rsquo;ll see that we&rsquo;re copying the file to the user&rsquo;s home directory (since we did not specify a <code>path</code> attribute, the resource&rsquo;s name is also the path to the location where it will be stored), and we&rsquo;re using the <code>mode</code>, <code>owner</code>, and <code>group</code> attributes to set the file&rsquo;s mode, owner, and group, respectively.</p>

<p>Afterwards, we&rsquo;re using <code>bash</code> to install rbenv. Because we&rsquo;re not doing a system-wide install, we run the rbnev installer under the user we created earlier, and we use the <code>cwd</code> attribute to run the install inside the user&rsquo;s home directory. Once that&rsquo;s done, the last <code>bash</code> block then uses rbenv to install Ruby itself.</p>

<h2>Installing Redis</h2>

<p>Next in line is Redis, so go ahead and create a new file called <code>redis.rb</code>:</p>

<figure class='code'><figcaption><span>redis.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">package</span> <span class="s2">&quot;tcl8.5&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># download redis</span>
</span><span class='line'><span class="n">remote_file</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/redis-</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;redis&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;http://download.redis.io/releases/redis-</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;redis&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:create_if_missing</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># install redis</span>
</span><span class='line'><span class="n">bash</span> <span class="s1">&#39;install redis&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">cwd</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    tar xzf redis-#{node[&#39;redis&#39;][&#39;version&#39;]}.tar.gz</span>
</span><span class='line'><span class="sh">    cd redis-#{node[&#39;redis&#39;][&#39;version&#39;]}</span>
</span><span class='line'><span class="sh">    make &amp;&amp; make install</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;/usr/local/bin/redis-server&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>           <span class="sb">`redis-server --version`</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">split</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;v=</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;redis&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># install redis server</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;curl -L https://gist.githubusercontent.com/vladigleba/28f4f6b4454947c5223e/raw | sh&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">cwd</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/redis-</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;redis&#39;</span><span class="o">][</span><span class="s1">&#39;version&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/utils&quot;</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;ls /etc/init.d | grep redis&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This recipe doesn&rsquo;t contain any new Chef concepts. It simply downloads Redis using the <code>remote_file</code> resource, installs it using the <code>bash</code> resource, and installs the Redis server with the <code>execute</code> resource.</p>

<h2>Installing Nginx</h2>

<p>The last thing left to install is Nginx, and here&rsquo;s the code that will go in a new <code>nginx.rb</code> file to do just that:</p>

<figure class='code'><figcaption><span>nginx.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">package</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># remove default nginx config</span>
</span><span class='line'><span class="n">default_path</span> <span class="o">=</span> <span class="s2">&quot;/etc/nginx/sites-enabled/default&quot;</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;rm -f </span><span class="si">#{</span><span class="n">default_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">only_if</span> <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">default_path</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># start nginx</span>
</span><span class='line'><span class="n">service</span> <span class="s2">&quot;nginx&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">supports</span> <span class="o">[</span><span class="ss">:status</span><span class="p">,</span> <span class="ss">:restart</span><span class="o">]</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:start</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># set custom nginx config</span>
</span><span class='line'><span class="n">template</span> <span class="s2">&quot;/etc/nginx/sites-enabled/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;nginx.conf.erb&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">owner</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">&quot;service[nginx]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is only one new Chef concept here, and that&rsquo;s the <a href="http://docs.getchef.com/chef/resources.html#template"><code>template</code> resource</a>. It&rsquo;s similar to the <code>cookbook_file</code> resource in that it copies a file from a cookbook to a location on a node, but it also does much more than that; it allows you to modify the contents of the file by embedding Ruby code into it using ERB (Embedded Ruby) templates, just like you would if you wrote Ruby on Rails views in ERB. All the attributes that are accessible in your recipes are also accessible in template files, and when you combine this with the usual ERB features like conditional statements and blocks, you&rsquo;ll be able to customize your files in any way you want.</p>

<p>Templates are stored in your cookbook&rsquo;s <code>/templates</code> directory, so go ahead and create a new file there called <code>nginx.conf.erb</code> with the following code (note that the syntax for accessing attributes doesn&rsquo;t change):</p>

<figure class='code'><figcaption><span>nginx.conf.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">upstream unicorn {</span>
</span><span class='line'><span class="x">  server unix:/tmp/unicorn.</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">.sock fail_timeout=0;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">server {</span>
</span><span class='line'><span class="x">  server_name www.</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">.com;</span>
</span><span class='line'><span class="x">  return 301 $scheme://</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">.com$request_uri;</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">server {</span>
</span><span class='line'><span class="x">  listen 80 default deferred;</span>
</span><span class='line'><span class="x">  server_name </span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">.com;</span>
</span><span class='line'><span class="x">  root /var/www/</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">/current/public;</span>
</span><span class='line'>
</span><span class='line'><span class="x">  location ^~ /assets/ {</span>
</span><span class='line'><span class="x">    gzip_static on;</span>
</span><span class='line'><span class="x">    expires max;</span>
</span><span class='line'><span class="x">    add_header Cache-Control public;</span>
</span><span class='line'><span class="x">  }</span>
</span><span class='line'>
</span><span class='line'><span class="x">  try_files $uri/index.html $uri @unicorn;</span>
</span><span class='line'><span class="x">  location @unicorn {</span>
</span><span class='line'><span class="x">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
</span><span class='line'><span class="x">    proxy_set_header Host $http_host;</span>
</span><span class='line'><span class="x">    proxy_redirect off;</span>
</span><span class='line'><span class="x">    proxy_pass http://unicorn;</span>
</span><span class='line'><span class="x">  }</span>
</span><span class='line'>
</span><span class='line'><span class="x">  error_page 500 502 503 504 /500.html;</span>
</span><span class='line'><span class="x">  keepalive_timeout 5;</span>
</span><span class='line'><span class="x">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the file we&rsquo;re referencing inside the <code>template</code> resource in <code>nginx.rb</code>. You&rsquo;ll notice the attributes we specify there are very similar to those specified in the <code>cookbook_file</code> resources we wrote earlier. But one thing that&rsquo;s different is we&rsquo;re also using the <code>notifies</code> attribute to call <code>restart</code> on the previously defined Nginx service, which allows the new configuration file to be loaded in.</p>

<h2>App Setup</h2>

<p>Our final recipe does some setup for our Rails application. Here&rsquo;s the code you&rsquo;ll need to add to a new file called <code>app.rb</code>:</p>

<figure class='code'><figcaption><span>app.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># create www directory</span>
</span><span class='line'><span class="n">directory</span> <span class="s2">&quot;/var/www&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0755</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create shared directory structure for app</span>
</span><span class='line'><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/var/www/</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/shared/config&quot;</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">creates</span> <span class="n">path</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create database.yml file</span>
</span><span class='line'><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/database.yml&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;database.yml.erb&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0640</span>
</span><span class='line'>  <span class="n">owner</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># set unicorn config</span>
</span><span class='line'><span class="n">template</span> <span class="s2">&quot;/etc/init.d/unicorn_</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;unicorn.sh.erb&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0755</span>
</span><span class='line'>  <span class="n">owner</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">group</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;group&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># add init script link</span>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;update-rc.d unicorn_</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> defaults&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="s2">&quot;ls /etc/rc2.d | grep unicorn_</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only new resource here is <a href="http://docs.getchef.com/chef/resources.html#directory"><code>directory</code></a>, which we use to create a new <code>/var/www</code> directory for our Rails app. One other new thing is the <code>creates</code> attribute inside the second <code>execute</code> resource, which is used to prevent the resource from creating the <code>/var/www/phindee/shared/config</code> directory if it already exists. If you&rsquo;re wondering why we&rsquo;re using <code>execute</code> and not <code>directory</code>, it&rsquo;s because it&rsquo;s pretty messy to create recursive directories using <code>directory</code>, and this just seems cleaner to me.</p>

<p>And finally, here are the two template files we&rsquo;re referencing inside the <code>template</code> resources above:</p>

<figure class='code'><figcaption><span>database.yml.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">production:</span>
</span><span class='line'><span class="x">  adapter: postgresql</span>
</span><span class='line'><span class="x">  encoding: unicode</span>
</span><span class='line'><span class="x">  database: </span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  pool: 5</span>
</span><span class='line'><span class="x">  host: localhost</span>
</span><span class='line'><span class="x">  username: </span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;db&#39;</span><span class="o">][</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  password: </span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;db&#39;</span><span class="o">][</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;password&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>unicorn.sh.erb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="x">set -e</span>
</span><span class='line'><span class="x"># Example init script, this can be used with nginx, too,</span>
</span><span class='line'><span class="x"># since nginx and unicorn accept the same signals</span>
</span><span class='line'>
</span><span class='line'><span class="x"># Feel free to change any of the following variables for your app:</span>
</span><span class='line'><span class="x">TIMEOUT=${TIMEOUT-60}</span>
</span><span class='line'><span class="x">APP_ROOT=/var/www/</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x">/current</span>
</span><span class='line'><span class="x">PID=$APP_ROOT/tmp/pids/unicorn.pid</span>
</span><span class='line'><span class="x">CMD=&quot;cd $APP_ROOT; ~/.rbenv/bin/rbenv exec bundle exec unicorn -D -c $APP_ROOT/config/unicorn.rb -E production&quot;</span>
</span><span class='line'><span class="x">AS_USER=</span><span class="cp">&lt;%=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;user&#39;</span><span class="o">][</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">set -u</span>
</span><span class='line'>
</span><span class='line'><span class="x">OLD_PIN=&quot;$PID.oldbin&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="x">sig () {</span>
</span><span class='line'><span class="x">  test -s &quot;$PID&quot; &amp;&amp; kill -$1 `cat $PID`</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">oldsig () {</span>
</span><span class='line'><span class="x">  test -s $OLD_PIN &amp;&amp; kill -$1 `cat $OLD_PIN`</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">run () {</span>
</span><span class='line'><span class="x">  if [ &quot;$(id -un)&quot; = &quot;$AS_USER&quot; ]; then</span>
</span><span class='line'><span class="x">    eval $1</span>
</span><span class='line'><span class="x">  else</span>
</span><span class='line'><span class="x">    su -c &quot;$1&quot; - $AS_USER</span>
</span><span class='line'><span class="x">  fi</span>
</span><span class='line'><span class="x">}</span>
</span><span class='line'>
</span><span class='line'><span class="x">case &quot;$1&quot; in</span>
</span><span class='line'><span class="x">start)</span>
</span><span class='line'><span class="x">  sig 0 &amp;&amp; echo &gt;&amp;2 &quot;Already running&quot; &amp;&amp; exit 0</span>
</span><span class='line'><span class="x">  run &quot;$CMD&quot;</span>
</span><span class='line'><span class="x">  ;;</span>
</span><span class='line'><span class="x">stop)</span>
</span><span class='line'><span class="x">  sig QUIT &amp;&amp; exit 0</span>
</span><span class='line'><span class="x">  echo &gt;&amp;2 &quot;Not running&quot;</span>
</span><span class='line'><span class="x">  ;;</span>
</span><span class='line'><span class="x">force-stop)</span>
</span><span class='line'><span class="x">  sig TERM &amp;&amp; exit 0</span>
</span><span class='line'><span class="x">  echo &gt;&amp;2 &quot;Not running&quot;</span>
</span><span class='line'><span class="x">  ;;</span>
</span><span class='line'><span class="x">restart|reload)</span>
</span><span class='line'><span class="x">  sig HUP &amp;&amp; echo reloaded OK &amp;&amp; exit 0</span>
</span><span class='line'><span class="x">  echo &gt;&amp;2 &quot;Couldn&#39;t reload, starting &#39;$CMD&#39; instead&quot;</span>
</span><span class='line'><span class="x">  run &quot;$CMD&quot;</span>
</span><span class='line'><span class="x">  ;;</span>
</span><span class='line'><span class="x">upgrade)</span>
</span><span class='line'><span class="x">  if sig USR2 &amp;&amp; sleep 2 &amp;&amp; sig 0 &amp;&amp; oldsig QUIT</span>
</span><span class='line'><span class="x">    then</span>
</span><span class='line'><span class="x">    n=$TIMEOUT</span>
</span><span class='line'><span class="x">    while test -s $OLD_PIN &amp;&amp; test $n -ge 0</span>
</span><span class='line'><span class="x">    do</span>
</span><span class='line'><span class="x">      printf &#39;.&#39; &amp;&amp; sleep 1 &amp;&amp; n=$(( $n - 1 ))</span>
</span><span class='line'><span class="x">    done</span>
</span><span class='line'><span class="x">    echo</span>
</span><span class='line'>
</span><span class='line'><span class="x">    if test $n -lt 0 &amp;&amp; test -s $OLD_PIN</span>
</span><span class='line'><span class="x">    then</span>
</span><span class='line'><span class="x">      echo &gt;&amp;2 &quot;$OLD_PIN still exists after $TIMEOUT seconds&quot;</span>
</span><span class='line'><span class="x">      exit 1</span>
</span><span class='line'><span class="x">    fi</span>
</span><span class='line'><span class="x">    exit 0</span>
</span><span class='line'><span class="x">  fi</span>
</span><span class='line'><span class="x">  echo &gt;&amp;2 &quot;Couldn&#39;t upgrade, starting &#39;$CMD&#39; instead&quot;</span>
</span><span class='line'><span class="x">  run &quot;$CMD&quot;</span>
</span><span class='line'><span class="x">  ;;</span>
</span><span class='line'><span class="x">reopen-logs)</span>
</span><span class='line'><span class="x">  sig USR1</span>
</span><span class='line'><span class="x">  ;;</span>
</span><span class='line'><span class="x">*)</span>
</span><span class='line'><span class="x">  echo &gt;&amp;2 &quot;Usage: $0 &lt;start|stop|restart|upgrade|force-stop|reopen-logs&gt;&quot;</span>
</span><span class='line'><span class="x">  exit 1</span>
</span><span class='line'><span class="x">  ;;</span>
</span><span class='line'><span class="x">esac</span>
</span></code></pre></td></tr></table></div></figure>


<p>And with that, our recipes are complete! We&rsquo;re now ready to use them to provision our node, and that&rsquo;s exactly what we&rsquo;ll cover in <a href="/blog/2014/08/13/provisioning-a-rails-server-using-chef-part-3-tying-it-all-together/">part 3</a>.</p>
</div>


  <footer>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/28/provisioning-a-rails-server-using-chef-part-1-introduction-to-chef-solo/" title="Previous Post: Provisioning a Rails Server Using Chef, Part 1: Introduction to Chef Solo">&laquo; Provisioning a Rails Server Using Chef, Part 1: Introduction to Chef Solo</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/09/02/provisioning-a-rails-server-using-chef-part-3-tying-it-all-together/" title="Next Post: Provisioning a Rails Server Using Chef, Part 3: Tying It All Together">Provisioning a Rails Server Using Chef, Part 3: Tying It All Together &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/02/provisioning-a-rails-server-using-chef-part-3-tying-it-all-together/">Provisioning a Rails Server Using Chef, Part 3: Tying It All Together</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/12/provisioning-a-rails-server-using-chef-part-2-writing-the-recipes/">Provisioning a Rails Server Using Chef, Part 2: Writing the Recipes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/28/provisioning-a-rails-server-using-chef-part-1-introduction-to-chef-solo/">Provisioning a Rails Server Using Chef, Part 1: Introduction to Chef Solo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/30/backup-a-rails-database-with-the-backup-and-whenever-gems/">Backup a Rails Database with the Backup and Whenever Gems</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/30/how-to-do-autocomplete-in-rails-using-redis/">How to Do Autocomplete in Rails Using Redis</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>Copyright &copy; 2014 Vladi Gleba</p>
<p>Produced in Portland, Oregon. Powered by <a href="http://octopress.org">Octopress</a> and <a href="https://github.com/vladigleba/readify">Readify</a>.</p>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'vladigleba';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://vladigleba.github.io/blog/2014/08/12/provisioning-a-rails-server-using-chef-part-2-writing-the-recipes/';
        var disqus_url = 'http://vladigleba.github.io/blog/2014/08/12/provisioning-a-rails-server-using-chef-part-2-writing-the-recipes/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u=(("https:" == document.location.protocol) ? "https" : "http") + "://107.170.255.153/piwik/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
    g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();

</script>
<noscript><p><img src="http://107.170.255.153/piwik/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

</body>
</html>
